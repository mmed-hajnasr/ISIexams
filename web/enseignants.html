<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Enseignants - Gestion des Examens ISI</title>

    <!-- Custom fonts for this template-->
    <link
      href="vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet" />
    
    <!-- DataTables CSS -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" />
    
    <!-- Custom styles for souhaits calendar -->
    <style>
      .exam-calendar {
        display: grid;
        gap: 1rem;
      }
      
      .exam-date {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
      }
      
      .exam-date h6 {
        margin-bottom: 0.75rem;
        color: #495057;
        font-weight: 600;
      }
      
      .session-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
      }
      
      .session-slot {
        padding: 0.75rem;
        border: 2px solid #dee2e6;
        border-radius: 0.25rem;
        cursor: pointer;
        text-align: center;
        font-size: 0.875rem;
        transition: all 0.2s;
        background-color: white;
      }
      
      .session-slot:hover {
        border-color: #007bff;
        transform: translateY(-1px);
      }
      
      .session-slot.available {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
      }
      
      .session-slot.unavailable {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }
      
      .session-slot.no-exam {
        background-color: #e2e3e5;
        border-color: #6c757d;
        color: #495057;
        cursor: not-allowed;
      }
      
      .session-time {
        font-weight: 600;
        display: block;
      }
      
      .session-name {
        font-size: 0.75rem;
        opacity: 0.8;
      }
      
      /* Conflict styling */
      .teacher-conflict-row {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
      }
      
      .teacher-conflict-row:hover {
        background-color: #ffeaa7 !important;
      }
      
      .conflict-badge {
        background-color: #dc3545;
        color: white;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
      }
      
      #conflictsWarning {
        border-left: 4px solid #ffc107;
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      
      /* Souhaits modal conflict styling */
      .session-slot.conflict {
        background-color: #8B0000 !important;
        border-color: #6B0000 !important;
        color: white !important;
        position: relative;
      }
      
      .session-slot.conflict::after {
        content: "‚ö†";
        position: absolute;
        top: 2px;
        right: 4px;
        font-size: 12px;
        color: #FFD700;
      }
      
      .session-slot.conflict:hover {
        background-color: #A52A2A !important;
        border-color: #8B0000 !important;
      }
      
      .conflict-legend {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #dc3545;
      }
      
      /* Responsible session styling */
      .session-slot.responsible::before {
        content: "üë§";
        position: absolute;
        top: 2px;
        left: 4px;
        font-size: 12px;
      }
      
      .session-slot.responsible {
        position: relative;
      }
    </style>
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      >
        <!-- Sidebar - Brand -->
        <a
          class="sidebar-brand d-flex align-items-center justify-content-center"
          href="seances.html"
        >
          <img src="img/isi-logo.png" style="width: 50px; height: 50px" />
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0" />

        <!-- Nav Item - Dashboard -->
        <li class="nav-item">
          <a class="nav-link" href="seances.html">
            <i class="fas fa-fw fa-calendar"></i>
            <span>Seances</span></a
          >
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="enseignants.html">
            <i class="fas fa-fw fa-user"></i>
            <span>Enseignants</span></a
          >
        </li>
        
        <li class="nav-item">
          <a class="nav-link" href="configuration.html">
            <i class="fas fa-fw fa-cog"></i>
            <span>Param√®tres</span>
          </a>
        </li>

        <hr class="sidebar-divider" />
        <!-- Heading -->
        <div class="sidebar-heading">G√©n√©ration</div>

        <li class="nav-item">
          <a class="nav-link" href="assignements.html">
            <i class="fas fa-fw fa-users"></i>
            <span>Assignements</span></a
          >
        </li>

        <li class="nav-item">
          <a class="nav-link" href="emploi.html">
            <i class="fas fa-fw fa-calendar-check"></i>
            <span>Emplois du Temps</span></a
          >
        </li>

        <!-- Nav Item - Pages Collapse Menu -->
      </ul>
      <!-- End of Sidebar -->

      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Begin Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <div class="mb-3"></div>
            <div
              class="d-sm-flex align-items-center justify-content-between mb-4"
            >
              <h1 class="h3 mb-0 text-gray-800">Enseignants</h1>
              <div>
                <button
                  id="addTeacherBtn"
                  class="btn btn-sm btn-success shadow-sm mr-2"
                >
                  <i class="fas fa-plus fa-sm text-white-50"></i> Ajouter Enseignant
                </button>
                <button
                  id="clearAllBtn"
                  class="btn btn-sm btn-warning shadow-sm mr-2"
                >
                  <i class="fas fa-trash-alt fa-sm text-white-50"></i> Vider Tout
                </button>
                <button
                  id="exportTeachersBtn"
                  class="btn btn-sm btn-info shadow-sm mr-2"
                >
                  <i class="fas fa-upload fa-sm text-white-50"></i> Exporter CSV
                </button>
                <button
                  id="clearSouhaitsBtn"
                  class="btn btn-sm btn-outline-secondary shadow-sm mr-2"
                >
                  <i class="fas fa-eraser fa-sm"></i> Vider Souhaits
                </button>
                <button
                  id="importSouhaitsBtn"
                  class="btn btn-sm btn-secondary shadow-sm mr-2"
                >
                  <i class="fas fa-calendar-times fa-sm text-white-50"></i> Importer Souhaits
                </button>
                <button
                  id="importTeachersBtn"
                  class="btn btn-sm btn-primary shadow-sm"
                >
                  <i class="fas fa-download fa-sm text-white-50"></i> Importer Enseignants
                </button>
              </div>
            </div>

            <!-- Conflicts Warning -->
            <div id="conflictsWarning" class="alert alert-warning d-none" role="alert">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle mr-3 text-warning" style="font-size: 1.5rem;"></i>
                <div>
                  <strong>Conflits d√©tect√©s!</strong>
                  <div id="conflictsSummary"></div>
                  <button class="btn btn-sm btn-outline-warning mt-2" id="showConflictsDetailsBtn">
                    <i class="fas fa-eye"></i> Voir les d√©tails
                  </button>
                </div>
              </div>
            </div>

            <!-- Content Row -->
            <div class="row">
              <div class="col-12">
                <!-- Teachers Table -->
                <div class="card shadow mb-4">
                  <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                      Liste des Enseignants
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-bordered" id="teachersTable" width="100%" cellspacing="0">
                        <thead>
                          <tr>
                            <th>Code</th>
                            <th>Nom</th>
                            <th>Pr√©nom</th>
                            <th>Email</th>
                            <th>Grade</th>
                            <th>Surveillance</th>
                            <th>Souhaits</th>
                            <th>Actions</th>
                          </tr>
                        </thead>
                        <tbody id="teachersTableBody">
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Add/Edit Teacher Modal -->
            <div class="modal fade" id="teacherModal" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="teacherModalTitle">Ajouter Enseignant</h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <form id="teacherForm">
                    <div class="modal-body">
                      <input type="hidden" id="originalEmail" />
                      <div class="form-group">
                        <label for="teacherNom">Nom *</label>
                        <input type="text" class="form-control" id="teacherNom" required />
                      </div>
                      <div class="form-group">
                        <label for="teacherPrenom">Pr√©nom *</label>
                        <input type="text" class="form-control" id="teacherPrenom" required />
                      </div>
                      <div class="form-group">
                        <label for="teacherEmail">Email *</label>
                        <input type="email" class="form-control" id="teacherEmail" required />
                      </div>
                      <div class="form-group">
                        <label for="teacherGrade">Grade *</label>
                        <input type="text" class="form-control" id="teacherGrade" required />
                      </div>
                      <div class="form-group">
                        <label for="teacherCode">Code Smartex</label>
                        <input type="number" class="form-control" id="teacherCode" />
                      </div>
                      <div class="form-group">
                        <div class="form-check">
                          <input type="checkbox" class="form-check-input" id="teacherSurveillance" />
                          <label class="form-check-label" for="teacherSurveillance">
                            Participe √† la surveillance
                          </label>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        Annuler
                      </button>
                      <button type="submit" class="btn btn-primary">
                        Sauvegarder
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Import CSV Modal -->
            <div class="modal fade" id="importModal" tabindex="-1" role="dialog">
              <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Importer Enseignants depuis CSV/XLSX</h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p>
                      S√©lectionnez un fichier CSV ou XLSX avec les colonnes suivantes:
                      <code>nom_ens, prenom_ens, email_ens, grade_code_ens, code_smartex_ens, participe_surveillance</code>
                    </p>
                    <input type="file" id="csvFileInput" accept=".csv,.xlsx" class="form-control-file" />
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                      Annuler
                    </button>
                    <button type="button" id="importCsvBtn" class="btn btn-primary">
                      Importer
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Import Souhaits Modal -->
            <div class="modal fade" id="importSouhaitsModal" tabindex="-1" role="dialog">
              <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Importer Souhaits depuis CSV/XLSX</h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="alert alert-info">
                      <i class="fas fa-info-circle"></i>
                      <strong>Attention:</strong> L'importation effacera tous les souhaits existants avant d'ajouter les nouveaux.
                    </div>
                    <p>
                      S√©lectionnez un fichier CSV ou XLSX avec les colonnes suivantes:
                      <code>Enseignant, Semestre, Session, Jour, S√©ances</code>
                    </p>
                    <input type="file" id="csvSouhaitsFileInput" accept=".csv,.xlsx" class="form-control-file" />
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                      Annuler
                    </button>
                    <button type="button" id="importSouhaitsCsvBtn" class="btn btn-primary">
                      Importer
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Edit Souhaits Modal -->
            <div class="modal fade" id="souhaitsModal" tabindex="-1" role="dialog">
              <div class="modal-dialog modal-xl" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="souhaitsModalTitle">G√©rer les Souhaits</h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <!-- Warning area -->
                    <div id="souhaitsWarning" class="alert alert-warning d-none">
                    </div>
                    
                    <!-- Conflicts warning area -->
                    <div id="souhaitsConflictsWarning" class="alert alert-danger d-none">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <div>
                          <strong>Conflits d√©tect√©s!</strong>
                          <div id="souhaitsConflictsList"></div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Teacher info -->
                    <div class="mb-3">
                      <h6>Enseignant: <span id="souhaitsTeacherName" class="font-weight-bold"></span></h6>
                    </div>
                    
                    <!-- Semester and Session info -->
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label>Semestre:</label>
                        <input type="text" id="souhaitsSemestre" class="form-control" readonly />
                      </div>
                      <div class="col-md-6">
                        <label>Session:</label>
                        <input type="text" id="souhaitsSession" class="form-control" readonly />
                      </div>
                    </div>
                    
                    <!-- Calendar -->
                    <div class="mb-3">
                      <h6>Calendrier des Examens</h6>
                      <p class="text-muted">Cliquez sur les cr√©neaux o√π l'enseignant ne peut PAS participer √† la surveillance.</p>
                      <div id="examCalendar" class="border rounded p-3">
                        <!-- Calendar will be populated by JavaScript -->
                      </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="row">
                      <div class="col-12">
                        <small class="text-muted">
                          <i class="fas fa-square text-success"></i> Disponible &nbsp;
                          <i class="fas fa-square text-danger"></i> Non disponible &nbsp;
                          <i class="fas fa-square text-secondary"></i> Pas d'examen &nbsp;
                          <span style="color: #8B0000;"><i class="fas fa-square"></i></span> Conflit (affect√© mais indisponible) ‚ö† &nbsp;
                          üë§ Responsable
                        </small>
                        <div id="conflictLegendDetails" class="conflict-legend d-none mt-2">
                          <strong>Conflits d√©tect√©s:</strong> Cet enseignant est affect√© √† des cr√©neaux marqu√©s en rouge fonc√© mais a indiqu√© √™tre indisponible.
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                      Annuler
                    </button>
                    <button type="button" id="saveSouhaitsBtn" class="btn btn-primary">
                      Sauvegarder
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Message Modal -->
            <div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header" id="messageModalHeader">
                    <h5 class="modal-title" id="messageModalTitle"></h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" id="messageModalBody">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                      Fermer
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Confirmation Modal -->
            <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Confirmation</h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body" id="confirmModalBody">
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                      Annuler
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmModalBtn">
                      Confirmer
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Conflicts Details Modal -->
            <div class="modal fade" id="conflictsModal" tabindex="-1" role="dialog">
              <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                      D√©tails des Conflits de Surveillance
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p class="text-muted">
                      Les enseignants suivants sont affect√©s √† des cr√©neaux de surveillance pour lesquels ils ont indiqu√© √™tre indisponibles :
                    </p>
                    <div id="conflictsDetailsList">
                      <!-- Conflicts will be populated here -->
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                      Fermer
                    </button>
                  </div>
                </div>
              </div>
            </div>


          </div>
          <!-- /.container-fluid -->
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span>Copyright &copy; ISI Examens 2024</span>
            </div>
          </div>
        </footer>
        <!-- End of Footer -->
      </div>
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Eel JavaScript -->
    <script type="text/javascript" src="/eel.js"></script>
    
    <script>
      let teachersTable;
      let isEditMode = false;

      $(document).ready(function() {
        console.log('Enseignants page loaded');
        
        // Initialize DataTable
        initializeDataTable();
        
        // Load teachers data and conflicts
        loadTeachers();
        
        // Event handlers
        $('#addTeacherBtn').click(function() {
          openTeacherModal(false);
        });
        
        $('#clearAllBtn').click(function() {
          clearAllTeachers();
        });
        
        $('#exportTeachersBtn').click(function() {
          exportToCsv();
        });
        
        $('#clearSouhaitsBtn').click(function() {
          clearAllSouhaits();
        });
        
        $('#importSouhaitsBtn').click(function() {
          $('#importSouhaitsModal').modal('show');
        });
        
        $('#importTeachersBtn').click(function() {
          $('#importModal').modal('show');
        });
        
        $('#teacherForm').submit(function(e) {
          e.preventDefault();
          saveTeacher();
        });
        
        $('#importCsvBtn').click(function() {
          importFromCsv();
        });
        
        $('#importSouhaitsCsvBtn').click(function() {
          importSouhaitsFromCsv();
        });
        
        $('#saveSouhaitsBtn').click(function() {
          saveSouhaits();
        });
        
        $('#showConflictsDetailsBtn').click(function() {
          showConflictsModal();
        });
      });

      function initializeDataTable() {
        teachersTable = $('#teachersTable').DataTable({
          "pageLength": 25,
          "order": [[ 1, "asc" ]],
          "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
          }
        });
      }

      function loadTeachers() {
        Promise.all([
          new Promise(resolve => eel.get_enseignants_list()(resolve)),
          new Promise(resolve => eel.get_conflict_summary()(resolve))
        ]).then(([teachers, conflictSummary]) => {
          displayTeachers(teachers);
          displayConflictsSummary(conflictSummary);
        });
      }

      function displayTeachers(teachers) {
        teachersTable.clear();
        
        teachers.forEach(function(teacher) {
          const codeDisplay = teacher.code ? teacher.code : '-';
          const surveillanceDisplay = teacher.participe_surveillance ? 
            '<span class="badge badge-success">Oui</span>' : 
            '<span class="badge badge-secondary">Non</span>';
          
          let souhaitsDisplay = '';
          
          // Add conflict badge first if teacher has conflicts
          if (teacher.has_conflicts) {
            const conflictCount = teacher.conflicts ? teacher.conflicts.length : 0;
            souhaitsDisplay += `<span class="conflict-badge" title="Conflits d√©tect√©s">${conflictCount} conflit${conflictCount > 1 ? 's' : ''}</span> `;
          }
          
          // Add initialization status badge after conflict badge
          souhaitsDisplay += teacher.has_souhaits ? 
            '<span class="badge badge-info">Initialis√©s</span>' : 
            '<span class="badge badge-warning">Non initialis√©s</span>';
          
          const actionsHtml = `
            <button class="btn btn-sm btn-primary" onclick="editTeacher('${teacher.email}')" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-info ml-1" onclick="editSouhaits('${teacher.email}')" title="G√©rer les souhaits">
              <i class="fas fa-calendar-times"></i>
            </button>
            <button class="btn btn-sm btn-danger ml-1" onclick="deleteTeacher('${teacher.email}')" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          `;

          const row = teachersTable.row.add([
            codeDisplay,
            teacher.nom,
            teacher.prenom,
            teacher.email,
            teacher.grade,
            surveillanceDisplay,
            souhaitsDisplay,
            actionsHtml
          ]);
          
          // Add conflict styling to the row if teacher has conflicts
          if (teacher.has_conflicts) {
            row.node().classList.add('teacher-conflict-row');
          }
        });
        
        teachersTable.draw();
      }

      function openTeacherModal(edit = false, teacherData = null) {
        isEditMode = edit;
        
        if (edit && teacherData) {
          $('#teacherModalTitle').text('Modifier Enseignant');
          $('#originalEmail').val(teacherData.email);
          $('#teacherNom').val(teacherData.nom);
          $('#teacherPrenom').val(teacherData.prenom);
          $('#teacherEmail').val(teacherData.email);
          $('#teacherGrade').val(teacherData.grade);
          $('#teacherCode').val(teacherData.code || '');
          $('#teacherSurveillance').prop('checked', teacherData.participe_surveillance);
        } else {
          $('#teacherModalTitle').text('Ajouter Enseignant');
          $('#teacherForm')[0].reset();
          $('#originalEmail').val('');
        }
        
        $('#teacherModal').modal('show');
      }

      function editTeacher(email) {
        eel.get_enseignants_list()(function(teachers) {
          const teacher = teachers.find(t => t.email === email);
          if (teacher) {
            openTeacherModal(true, teacher);
          }
        });
      }

      function deleteTeacher(email) {
        showConfirmModal('√ätes-vous s√ªr de vouloir supprimer cet enseignant?', function() {
          eel.delete_enseignant(email)(function(result) {
            if (result.success) {
              showMessageModal('Succ√®s', result.message, 'success');
              loadTeachers(); // Refresh to update conflicts
            } else {
              showMessageModal('Erreur', result.error, 'danger');
            }
          });
        });
      }

      function clearAllTeachers() {
        showConfirmModal('√ätes-vous s√ªr de vouloir supprimer TOUS les enseignants? Cette action est irr√©versible!', function() {
          eel.clear_all_enseignants()(function(result) {
            if (result.success) {
              showMessageModal('Succ√®s', result.message, 'success');
              loadTeachers(); // Refresh to update conflicts
            } else {
              showMessageModal('Erreur', result.error, 'danger');
            }
          });
        });
      }

      function clearAllSouhaits() {
        showConfirmModal('√ätes-vous s√ªr de vouloir supprimer TOUS les souhaits? Cette action est irr√©versible!', function() {
          eel.clear_all_souhaits()(function(result) {
            if (result.success) {
              showMessageModal('Succ√®s', result.message, 'success');
              loadTeachers(); // Refresh to update conflicts
            } else {
              showMessageModal('Erreur', result.error, 'danger');
            }
          });
        });
      }

      function saveTeacher() {
        const formData = {
          nom: $('#teacherNom').val().trim(),
          prenom: $('#teacherPrenom').val().trim(),
          email: $('#teacherEmail').val().trim(),
          grade: $('#teacherGrade').val().trim(),
          code: $('#teacherCode').val().trim(),
          participe_surveillance: $('#teacherSurveillance').is(':checked')
        };

        // Validation
        if (!formData.nom || !formData.prenom || !formData.email || !formData.grade) {
          showMessageModal('Attention', 'Veuillez remplir tous les champs obligatoires', 'warning');
          return;
        }

        if (isEditMode) {
          const originalEmail = $('#originalEmail').val();
          eel.update_enseignant(originalEmail, formData.nom, formData.prenom, 
                               formData.email, formData.grade, formData.code, 
                               formData.participe_surveillance)(function(result) {
            handleSaveResult(result);
          });
        } else {
          eel.add_enseignant(formData.nom, formData.prenom, formData.email, 
                            formData.grade, formData.code, formData.participe_surveillance)(function(result) {
            handleSaveResult(result);
          });
        }
      }

      function handleSaveResult(result) {
        if (result.success) {
          showMessageModal('Succ√®s', result.message, 'success');
          $('#teacherModal').modal('hide');
          loadTeachers(); // This will reload both teachers and conflicts
        } else {
          showMessageModal('Erreur', result.error, 'danger');
        }
      }

      function importFromCsv() {
        const fileInput = document.getElementById('csvFileInput');
        const file = fileInput.files[0];
        
        if (!file) {
          showMessageModal('Attention', 'Veuillez s√©lectionner un fichier CSV ou XLSX', 'warning');
          return;
        }

        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx')) {
          showMessageModal('Erreur', 'Veuillez s√©lectionner un fichier CSV ou XLSX valide', 'danger');
          return;
        }

        // Read file based on type
        if (fileName.endsWith('.xlsx')) {
          // Read as binary for XLSX files
          const reader = new FileReader();
          reader.onload = function(e) {
            // Convert ArrayBuffer to base64
            const bytes = new Uint8Array(e.target.result);
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
              binary += String.fromCharCode(bytes[i]);
            }
            const base64Content = btoa(binary);
            
            eel.import_enseignants_from_file_content(base64Content, file.name)(function(result) {
              if (result.success) {
                showMessageModal('Succ√®s', `${result.message} (${result.count} enseignants)`, 'success');
                $('#importModal').modal('hide');
                loadTeachers(); // Refresh to update conflicts
              } else {
                showMessageModal('Erreur', result.error, 'danger');
              }
            });
          };
          reader.readAsArrayBuffer(file);
        } else {
          // Read as text for CSV files
          const reader = new FileReader();
          reader.onload = function(e) {
            const csvContent = e.target.result;
            
            eel.import_enseignants_from_file_content(csvContent, file.name)(function(result) {
              if (result.success) {
                showMessageModal('Succ√®s', `${result.message} (${result.count} enseignants)`, 'success');
                $('#importModal').modal('hide');
                loadTeachers(); // Refresh to update conflicts
              } else {
                showMessageModal('Erreur', result.error, 'danger');
              }
            });
          };
          reader.readAsText(file);
        }
      }

      function exportToCsv() {
        eel.export_enseignants_csv()(function(result) {
          if (result.success) {
            // Create download link
            const blob = new Blob([result.csv_content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', result.filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessageModal('Succ√®s', 'Fichier CSV export√© avec succ√®s', 'success');
          } else {
            showMessageModal('Erreur', result.error, 'danger');
          }
        });
      }

      function importSouhaitsFromCsv() {
        const fileInput = document.getElementById('csvSouhaitsFileInput');
        const file = fileInput.files[0];
        
        if (!file) {
          showMessageModal('Attention', 'Veuillez s√©lectionner un fichier CSV ou XLSX', 'warning');
          return;
        }

        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx')) {
          showMessageModal('Erreur', 'Veuillez s√©lectionner un fichier CSV ou XLSX valide', 'danger');
          return;
        }

        // Read file based on type
        if (fileName.endsWith('.xlsx')) {
          // Read as binary for XLSX files
          const reader = new FileReader();
          reader.onload = function(e) {
            // Convert ArrayBuffer to base64
            const bytes = new Uint8Array(e.target.result);
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
              binary += String.fromCharCode(bytes[i]);
            }
            const base64Content = btoa(binary);
            
            eel.import_souhaits_from_file_content(base64Content, file.name)(function(result) {
              if (result.success) {
                let message = result.message;
                if (result.warnings && Object.keys(result.warnings).length > 0) {
                  message += '<br><br><strong>Avertissements:</strong><ul>';
                  for (const [teacher, errors] of Object.entries(result.warnings)) {
                    message += `<li>${teacher}: ${errors.join(', ')}</li>`;
                  }
                  message += '</ul>';
                }
                showMessageModal('Succ√®s', message, 'success');
                $('#importSouhaitsModal').modal('hide');
                loadTeachers(); // Refresh to update conflicts
              } else {
                showMessageModal('Erreur', result.error, 'danger');
              }
            });
          };
          reader.readAsArrayBuffer(file);
        } else {
          // Read as text for CSV files
          const reader = new FileReader();
          reader.onload = function(e) {
            const csvContent = e.target.result;
            
            eel.import_souhaits_from_file_content(csvContent, file.name)(function(result) {
              if (result.success) {
                let message = result.message;
                if (result.warnings && Object.keys(result.warnings).length > 0) {
                  message += '<br><br><strong>Avertissements:</strong><ul>';
                  for (const [teacher, errors] of Object.entries(result.warnings)) {
                    message += `<li>${teacher}: ${errors.join(', ')}</li>`;
                  }
                  message += '</ul>';
                }
                showMessageModal('Succ√®s', message, 'success');
                $('#importSouhaitsModal').modal('hide');
                loadTeachers(); // Refresh to update conflicts
              } else {
                showMessageModal('Erreur', result.error, 'danger');
              }
            });
          };
          reader.readAsText(file);
        }
      }

      let currentTeacherEmail = null;
      let examScheduleData = null;
      let currentUnavailableSlots = new Set();
      let currentTeacherConflicts = [];
      let currentTeacherAssignments = [];

      function editSouhaits(email) {
        currentTeacherEmail = email;
        
        // Get teacher info
        eel.get_enseignants_list()(function(teachers) {
          const teacher = teachers.find(t => t.email === email);
          if (!teacher) {
            showMessageModal('Erreur', 'Enseignant introuvable', 'danger');
            return;
          }
          
          $('#souhaitsTeacherName').text(`${teacher.prenom} ${teacher.nom}`);
          
          // Store teacher conflicts for use in calendar building
          currentTeacherConflicts = teacher.conflicts || [];
          
          // Get exam schedule, teacher's current souhaits, and responsibilities
          Promise.all([
            new Promise(resolve => eel.get_exam_schedule_for_souhaits()(resolve)),
            new Promise(resolve => eel.get_enseignant_souhaits(email)(resolve)),
            new Promise(resolve => eel.get_teacher_responsibilities(email)(resolve))
          ]).then(([scheduleResult, souhaitsResult, responsibilitiesResult]) => {
            
            if (!scheduleResult.success) {
              showMessageModal('Erreur', scheduleResult.error, 'danger');
              return;
            }
            
            examScheduleData = scheduleResult;
            
            // Show warning if no exam sessions
            if (scheduleResult.warning) {
              $('#souhaitsWarning').removeClass('d-none').html(
                '<i class="fas fa-exclamation-triangle"></i> ' + scheduleResult.warning
              );
            } else {
              $('#souhaitsWarning').addClass('d-none');
            }
            
            // Set semester and session
            $('#souhaitsSemestre').val(scheduleResult.semester || 'Non d√©fini');
            $('#souhaitsSession').val(scheduleResult.session || 'Non d√©fini');
            
            // Load current souhaits
            currentUnavailableSlots.clear();
            if (souhaitsResult.success && souhaitsResult.souhaits.unavailable_slots) {
              souhaitsResult.souhaits.unavailable_slots.forEach(slot => {
                currentUnavailableSlots.add(`${slot[0]}-${slot[1]}`);
              });
            }
            
            // Load teacher assignments
            currentTeacherAssignments = [];
            if (responsibilitiesResult.success) {
              currentTeacherAssignments = responsibilitiesResult.responsibilities || [];
            }
            
            // Show conflicts warning if any
            displaySouhaitsConflicts();
            
            // Build calendar
            buildExamCalendar();
            
            $('#souhaitsModal').modal('show');
          });
        });
      }

      function displaySouhaitsConflicts() {
        const conflictsWarning = $('#souhaitsConflictsWarning');
        const conflictsList = $('#souhaitsConflictsList');
        const conflictLegend = $('#conflictLegendDetails');
        
        if (currentTeacherConflicts.length > 0) {
          const conflictsHtml = currentTeacherConflicts.map(function(conflict) {
            return `<li><strong>${conflict.date}</strong> - ${conflict.seance_name}</li>`;
          }).join('');
          
          conflictsList.html(`
            <small><strong>Attention:</strong> Cet enseignant est programm√© pour surveiller ${currentTeacherConflicts.length} cr√©neau${currentTeacherConflicts.length > 1 ? 'x' : ''} 
            pour ${currentTeacherConflicts.length > 1 ? 'lesquels' : 'lequel'} il a indiqu√© √™tre indisponible:</small>
            <ul class="mb-0 mt-1">${conflictsHtml}</ul>
            <small class="text-muted mt-1">Les cr√©neaux en conflit sont marqu√©s en rouge fonc√© dans le calendrier ci-dessous.</small>
          `);
          
          conflictsWarning.removeClass('d-none');
          conflictLegend.removeClass('d-none');
        } else {
          conflictsWarning.addClass('d-none');
          conflictLegend.addClass('d-none');
        }
      }

      function buildExamCalendar() {
        const calendarContainer = $('#examCalendar');
        calendarContainer.empty();
        
        if (!examScheduleData || !examScheduleData.dates || examScheduleData.dates.length === 0) {
          calendarContainer.html('<p class="text-muted">Aucune date d\'examen disponible</p>');
          return;
        }
        
        calendarContainer.addClass('exam-calendar');
        
        examScheduleData.dates.forEach((date, dayIndex) => {
          const dateDiv = $('<div class="exam-date"></div>');
          
          // Date header
          const dateHeader = $(`<h6>${date}</h6>`);
          dateDiv.append(dateHeader);
          
          // Sessions grid
          const sessionsGrid = $('<div class="session-grid"></div>');
          
          const sessionsForDate = examScheduleData.sessions_by_date[date] || [];
          
          if (sessionsForDate.length === 0) {
            sessionsGrid.append('<div class="session-slot no-exam">Pas d\'examen</div>');
          } else {
            sessionsForDate.forEach((session) => {
              const slotKey = `${dayIndex + 1}-${session.index}`;
              const isUnavailable = currentUnavailableSlots.has(slotKey);
              
              // Check if this session has a conflict
              const hasConflict = currentTeacherConflicts.some(conflict => 
                conflict.day_number === (dayIndex + 1) && 
                conflict.seance_number === session.index
              );
              
              // Check if teacher is responsible for this session
              const isResponsible = currentTeacherAssignments.some(assignment => 
                assignment.day_number === (dayIndex + 1) && 
                assignment.seance_number === session.index
              );
              
              let sessionClass = 'available';
              if (hasConflict) {
                sessionClass = 'conflict';
              } else if (isUnavailable) {
                sessionClass = 'unavailable';
              }
              
              // Add responsible class if teacher is responsible
              if (isResponsible) {
                sessionClass += ' responsible';
              }
              
              let tooltipText = '';
              if (hasConflict) {
                tooltipText = 'CONFLIT: Vous √™tes affect√© √† surveiller ce cr√©neau mais avez indiqu√© √™tre indisponible. Cliquez pour r√©soudre le conflit.';
              } else if (isUnavailable) {
                const responsibleText = isResponsible ? ' (Vous √™tes responsable)' : '';
                tooltipText = 'Indisponible: Cliquez pour marquer comme disponible' + responsibleText;
              } else {
                const responsibleText = isResponsible ? ' (Vous √™tes responsable)' : '';
                tooltipText = 'Disponible: Cliquez pour marquer comme indisponible' + responsibleText;
              }
              
              const sessionSlot = $(`
                <div class="session-slot ${sessionClass}" 
                     data-day="${dayIndex + 1}" 
                     data-session="${session.index}"
                     title="${tooltipText}">
                  <span class="session-name">${session.name}</span>
                  <span class="session-time">${session.h_debut} - ${session.h_fin}</span>
                </div>
              `);
              
              sessionSlot.click(function() {
                toggleSlotAvailability($(this));
              });
              
              sessionsGrid.append(sessionSlot);
            });
          }
          
          dateDiv.append(sessionsGrid);
          calendarContainer.append(dateDiv);
        });
      }

      function toggleSlotAvailability(slotElement) {
        const day = slotElement.data('day');
        const session = slotElement.data('session');
        const slotKey = `${day}-${session}`;
        
        if (slotElement.hasClass('no-exam')) {
          return; // Can't toggle no-exam slots
        }
        
        // Check if teacher is responsible/assigned to this slot
        const isResponsible = currentTeacherAssignments.some(assignment => 
          assignment.day_number === day && 
          assignment.seance_number === session
        );
        
        if (slotElement.hasClass('conflict')) {
          // Clicking on a conflict slot means making yourself available (resolves conflict)
          currentUnavailableSlots.delete(slotKey);
          slotElement.removeClass('conflict').addClass('available');
          const responsibleText = isResponsible ? ' (Vous √™tes responsable)' : '';
          slotElement.attr('title', 'Disponible: Cliquez pour marquer comme indisponible' + responsibleText);
        } else if (currentUnavailableSlots.has(slotKey)) {
          // Currently unavailable, make available
          currentUnavailableSlots.delete(slotKey);
          slotElement.removeClass('unavailable').addClass('available');
          const responsibleText = isResponsible ? ' (Vous √™tes responsable)' : '';
          slotElement.attr('title', 'Disponible: Cliquez pour marquer comme indisponible' + responsibleText);
        } else {
          // Currently available, make unavailable
          currentUnavailableSlots.add(slotKey);
          
          if (isResponsible) {
            // If teacher is responsible and marking unavailable, it's a conflict
            slotElement.removeClass('available').addClass('conflict');
            slotElement.attr('title', 'CONFLIT: Vous √™tes affect√© √† surveiller ce cr√©neau mais avez indiqu√© √™tre indisponible. Cliquez pour r√©soudre le conflit.');
          } else {
            // If teacher is not responsible, just mark as unavailable (regular red)
            slotElement.removeClass('available').addClass('unavailable');
            const responsibleText = isResponsible ? ' (Vous √™tes responsable)' : '';
            slotElement.attr('title', 'Indisponible: Cliquez pour marquer comme disponible' + responsibleText);
          }
        }
        
        // Ensure responsible class is maintained if teacher is responsible
        if (isResponsible && !slotElement.hasClass('responsible')) {
          slotElement.addClass('responsible');
        }
      }

      function saveSouhaits() {
        if (!currentTeacherEmail) {
          showMessageModal('Erreur', 'Aucun enseignant s√©lectionn√©', 'danger');
          return;
        }
        
        const semestre = $('#souhaitsSemestre').val();
        const session = $('#souhaitsSession').val();
        
        // Convert unavailable slots to array format
        const unavailableSlots = Array.from(currentUnavailableSlots).map(slot => {
          const [day, sessionNum] = slot.split('-');
          return [parseInt(day), parseInt(sessionNum)];
        });
        
        eel.update_enseignant_souhaits(currentTeacherEmail, semestre, session, unavailableSlots)(function(result) {
          if (result.success) {
            // Update the current teacher's conflict data for immediate visual feedback
            eel.get_enseignants_list()(function(teachers) {
              const updatedTeacher = teachers.find(t => t.email === currentTeacherEmail);
              if (updatedTeacher) {
                currentTeacherConflicts = updatedTeacher.conflicts || [];
                displaySouhaitsConflicts();
                buildExamCalendar(); // Rebuild calendar with updated conflicts
              }
            });
            
            showMessageModal('Succ√®s', result.message, 'success');
            $('#souhaitsModal').modal('hide');
            loadTeachers(); // Refresh to show updated souhaits status and conflicts
          } else {
            showMessageModal('Erreur', result.error, 'danger');
          }
        });
      }

      function displayConflictsSummary(conflictSummary) {
        const warningDiv = $('#conflictsWarning');
        const summaryDiv = $('#conflictsSummary');
        
        if (conflictSummary.has_conflicts) {
          const conflictCount = conflictSummary.total_conflicts;
          const teacherCount = conflictSummary.conflicts.length;
          
          summaryDiv.html(`
            <span>${teacherCount} enseignant${teacherCount > 1 ? 's' : ''} ${teacherCount > 1 ? 'ont' : 'a'} des conflits d'affectation (${conflictCount} conflit${conflictCount > 1 ? 's' : ''} au total).</span>
            <br><small class="text-muted">Des enseignants sont affect√©s √† des cr√©neaux pour lesquels ils ont indiqu√© √™tre indisponibles.</small>
          `);
          
          // Store conflicts data for modal
          window.currentConflicts = conflictSummary.conflicts;
          
          warningDiv.removeClass('d-none');
        } else {
          warningDiv.addClass('d-none');
        }
      }

      function showConflictsModal() {
        const conflictsList = $('#conflictsDetailsList');
        conflictsList.empty();
        
        if (!window.currentConflicts || window.currentConflicts.length === 0) {
          conflictsList.html('<p class="text-muted">Aucun conflit d√©tect√©.</p>');
        } else {
          window.currentConflicts.forEach(function(conflict) {
            const conflictsHtml = conflict.conflicts.map(function(c) {
              return `<li><strong>${c.date}</strong> - ${c.seance_name} (${c.day_number}/${c.seance_number})</li>`;
            }).join('');
            
            const teacherCard = $(`
              <div class="card mb-3">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-user mr-2 text-warning"></i>
                    ${conflict.teacher_name}
                    <small class="text-muted">(${conflict.email})</small>
                    <span class="badge badge-danger ml-2">${conflict.conflicts.length} conflit${conflict.conflicts.length > 1 ? 's' : ''}</span>
                  </h6>
                </div>
                <div class="card-body">
                  <p class="mb-2"><strong>Cr√©neaux en conflit :</strong></p>
                  <ul class="mb-0">${conflictsHtml}</ul>
                </div>
              </div>
            `);
            
            conflictsList.append(teacherCard);
          });
        }
        
        $('#conflictsModal').modal('show');
      }

      function showMessageModal(title, message, type) {
        // Set modal colors based on type
        const modalHeader = $('#messageModalHeader');
        const modalTitle = $('#messageModalTitle');
        const modalBody = $('#messageModalBody');
        
        // Reset classes
        modalHeader.removeClass('bg-success bg-danger bg-warning bg-info');
        
        // Set appropriate styling
        switch(type) {
          case 'success':
            modalHeader.addClass('bg-success text-white');
            break;
          case 'danger':
            modalHeader.addClass('bg-danger text-white');
            break;
          case 'warning':
            modalHeader.addClass('bg-warning text-dark');
            break;
          default:
            modalHeader.addClass('bg-info text-white');
        }
        
        modalTitle.text(title);
        modalBody.html(message);
        $('#messageModal').modal('show');
      }

      function showConfirmModal(message, onConfirm) {
        $('#confirmModalBody').text(message);
        $('#confirmModal').modal('show');
        
        // Remove previous event handlers and add new one
        $('#confirmModalBtn').off('click').on('click', function() {
          $('#confirmModal').modal('hide');
          if (onConfirm) {
            onConfirm();
          }
        });
      }
    </script>
  </body>
</html>
